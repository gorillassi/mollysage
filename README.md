# Mollysage

Небольшой учебный мессенджер: личные диалоги, групповые беседы, отправка текста и картинок в браузерном клиенте. В проекте есть “E2E” часть для CLI (сообщения шифруются на клиенте), а для веб-клиента используется упрощённый plain-API; картинки на сервере хранятся в зашифрованном виде.

## Что умеет

- Регистрация и вход
- Личные диалоги
- Групповые беседы (создание, добавление участников)
- Список чатов и счётчик непрочитанных
- Онлайн-пользователи (presence)
- Отправка изображений (через plain_media)

## Структура

- main.go — запуск сервера, роутинг, статика
- http_handlers.go — HTTP обработчики
- storage.go — SQLite-хранилище (сообщения, группы, медиа, inbox)
- crypto.go — крипто-утилиты (ключи/шифрование)
- static/ — фронтенд (login.html, register.html, app.html, app.js)

## Требования

- Go 1.21+ (лучше 1.22/1.23)
- SQLite
- Зависимость: github.com/mattn/go-sqlite3

На Linux может понадобиться gcc и libsqlite3-dev.

## Запуск

1) Склонировать проект и перейти в папку:

git clone <your_repo_url>
cd mollysage

2) Подтянуть зависимости:

go mod tidy

3) Собрать и запустить:

go build -o mollysage .
./mollysage

По умолчанию сервер слушает :8080.

Открыть в браузере:
- http://localhost:8080/login.html — вход
- http://localhost:8080/register.html — регистрация
- после входа будет редирект на app.html

## Как это устроено (кратко)

### Авторизация в веб-клиенте
Вход делается на login.html. После успешного /login логин и пароль кладутся в sessionStorage.
app.js при старте читает sessionStorage и делает /login ещё раз, чтобы получить user_id.
Если в sessionStorage ничего нет — пользователь перекидывается обратно на login.html.

### Диалоги и беседы
- Личный чат: POST /chat/send, GET /chat/messages
- Группы: POST /groups/create, POST /groups/add_member, POST /groups/send, GET /groups/messages
- Список групп пользователя: GET /groups/by_user?user_id=...

### Непрочитанные
На фронте хранится lastRead по каждому чату. Новые сообщения считаются по id и по направлению:
- в личке непрочитанные — сообщения, где to_user_id == selfID
- в группе непрочитанные — все новые сообщения не от себя

Состояние по чатам сохраняется в localStorage отдельно для каждого username.

### Онлайн (presence)
Клиент раз в пару секунд делает:
- POST /presence/ping с user_id
- GET /presence/online — пользователи, активные за последние N секунд

## Подключение с другого устройства в одной сети

1) Узнать IP машины, где запущен сервер:
- Linux: ip a
- macOS: ifconfig

2) Открыть в браузере:
http://<IP_ТВОЕГО_ПК>:8080/login.html

## База данных

По умолчанию используется файл secure_chat.db в корне проекта.
Чтобы начать с нуля — удалить файл при остановленном сервере.

## Замечания

Проект учебный. Веб-часть использует plain-API и хранит пароль в sessionStorage.
E2E-шифрование полностью реализовано для CLI-клиента.
