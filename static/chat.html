<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Чат — Secure Social</title>
  <style>
    :root {
      --bg: #020617;
      --bg-dark: #020617;
      --panel: rgba(15,23,42,0.96);
      --border: rgba(31,41,55,0.9);
      --border-soft: rgba(148,163,184,0.35);
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.16);
      --accent-strong: #2563eb;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-xl: 24px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 0 0, rgba(59,130,246,0.2), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(45,212,191,0.18), transparent 55%),
        var(--bg-dark);
      display: flex;
    }

    .sidebar {
      width: 290px;
      padding: 18px 16px;
      border-right: 1px solid var(--border);
      background: linear-gradient(160deg, rgba(15,23,42,0.97), rgba(15,23,42,0.93));
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #22c55e, #3b82f6, #a855f7, #22c55e);
      position: relative;
      overflow: hidden;
    }
    .logo-mark::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: inherit;
      background: radial-gradient(circle at 30% 20%, rgba(248,250,252,0.95), rgba(15,23,42,0.98));
    }

    .logo-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .logo-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .chip {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,0.95);
      font-size: 11px;
      color: var(--muted);
    }

    .section-title {
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: rgba(156,163,175,0.9);
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .field {
      margin-bottom: 10px;
    }

    input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid rgba(55,65,81,0.95);
      background: rgba(15,23,42,0.96);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    input::placeholder { color: rgba(148,163,184,0.7); }
    input:focus {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(59,130,246,0.7),
        0 0 18px rgba(37,99,235,0.35);
      background: rgba(15,23,42,1);
    }

    #connectBtn {
      width: 100%;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow:
        0 10px 26px rgba(37,99,235,0.8),
        0 0 0 1px rgba(15,23,42,0.9);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }
    #connectBtn:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
    }
    #connectBtn:active {
      transform: translateY(0);
      box-shadow:
        0 6px 18px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.95);
    }

    #sideStatus {
      margin-top: 8px;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--muted);
      min-height: 14px;
    }
    #sideStatus.error { color: var(--danger); }
    #sideStatus.ok { color: #a7f3d0; }

    .chat-list {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.96);
      padding: 6px 6px;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 4px 6px;
      font-size: 11px;
      color: var(--muted);
    }

    #chatList {
      margin-top: 2px;
      overflow-y: auto;
      padding: 2px 0;
    }

    .chat-tab {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      border-radius: 999px;
      margin-bottom: 4px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid transparent;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, transform 0.05s ease;
    }

    .chat-tab.active {
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.32), transparent 60%),
                  rgba(15,23,42,0.98);
      border-color: rgba(59,130,246,0.7);
      color: var(--text);
      box-shadow: 0 6px 18px rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .chat-tab-name {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-tab-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
    }

    .sidebar-foot {
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
      border-top: 1px solid rgba(31,41,55,0.9);
      padding-top: 10px;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .chat-header {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.94));
    }

    .chat-header-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #chatTitle {
      font-size: 14px;
      font-weight: 500;
    }

    #chatSubtitle {
      font-size: 11px;
      color: var(--muted);
    }

    #idsInfo {
      font-size: 11px;
      color: rgba(156,163,175,0.95);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
    }

    .chat-messages {
      flex: 1;
      padding: 14px 18px;
      overflow-y: auto;
      background:
        radial-gradient(circle at 20% 0, rgba(59,130,246,0.18), transparent 60%),
        radial-gradient(circle at 100% 80%, rgba(34,197,94,0.16), transparent 65%),
        var(--bg);
    }

    .msg {
      max-width: 72%;
      padding: 8px 10px;
      border-radius: 12px;
      margin-bottom: 7px;
      font-size: 13px;
      line-height: 1.35;
      word-break: break-word;
      position: relative;
    }
    .msg.me {
      margin-left: auto;
      background: radial-gradient(circle at 0 0, rgba(191,219,254,0.35), transparent 60%),
                  rgba(37,99,235,0.95);
      border-bottom-right-radius: 4px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.7);
    }
    .msg.peer {
      background: radial-gradient(circle at 100% 0, rgba(34,197,94,0.28), transparent 65%),
                  rgba(15,23,42,0.96);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(148,163,184,0.35);
    }

    .msg-meta {
      font-size: 10px;
      color: rgba(209,213,219,0.9);
      margin-bottom: 2px;
      opacity: 0.9;
    }
    .msg.peer .msg-meta { color: rgba(148,163,184,0.95); }

    .chat-input {
      display: flex;
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.97));
      gap: 8px;
    }

    .chat-input textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 96px;
      font-family: inherit;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 11px;
      border: 1px solid rgba(55,65,81,0.98);
      background: rgba(15,23,42,0.96);
      color: var(--text);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    .chat-input textarea:focus {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(59,130,246,0.7),
        0 0 14px rgba(37,99,235,0.4);
      background: rgba(15,23,42,1);
    }

    .chat-input button {
      width: 110px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow:
        0 10px 24px rgba(37,99,235,0.8),
        0 0 0 1px rgba(15,23,42,0.9);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }
    .chat-input button:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
    }
    .chat-input button:active {
      transform: translateY(0);
      box-shadow:
        0 6px 18px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.95);
    }

    @media (max-width: 840px) {
      .sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="brand">
      <div class="logo">
        <div class="logo-mark"></div>
        <div>
          <div class="logo-title">Secure Social</div>
          <div class="logo-sub">чат поверх крипто-ядра</div>
        </div>
      </div>
      <div class="chip">browser chat</div>
    </div>

    <div class="section-title">Профиль</div>
    <div class="field">
      <label for="userName">Твой логин</label>
      <input id="userName" placeholder="alice">
    </div>
    <div class="field">
      <label for="userPass">Твой пароль</label>
      <input id="userPass" type="password" placeholder="alicepass">
    </div>

    <div class="section-title">Новый диалог</div>
    <div class="field">
      <label for="peerName">Логин собеседника</label>
      <input id="peerName" placeholder="bob">
    </div>
    <button id="connectBtn">Войти и открыть диалог</button>
    <div id="sideStatus"></div>

    <div class="section-title">Диалоги</div>
    <div class="chat-list">
      <div class="chat-list-header">
        <span>Активные чаты</span>
        <span style="font-size:10px;color:var(--muted);">кликни, чтобы переключиться</span>
      </div>
      <div id="chatList"></div>
    </div>

    <div class="sidebar-foot">
      <div>Эта страница использует plain-text API для демонстрации нескольких диалогов.</div>
      <div>Основной E2E-протокол — в Go-клиенте.</div>
    </div>
  </div>

  <div class="main">
    <div class="chat-header">
      <div class="chat-header-main">
        <div id="chatTitle">Диалог не выбран</div>
        <div id="chatSubtitle">Создай новый диалог слева или выбери из списка</div>
      </div>
      <div id="idsInfo"></div>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
      <textarea id="msgInput" placeholder="Напиши сообщение…" disabled></textarea>
      <button id="sendBtn" disabled>Отправить</button>
    </div>
  </div>

<script>
const connectBtn = document.getElementById('connectBtn');
const sideStatus = document.getElementById('sideStatus');
const chatTitle = document.getElementById('chatTitle');
const chatSubtitle = document.getElementById('chatSubtitle');
const idsInfo = document.getElementById('idsInfo');
const chatMessages = document.getElementById('chatMessages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const chatListEl = document.getElementById('chatList');

let selfID = null;
let selfName = null;
let pollTimer = null;

// username -> { peerID, lastMsgID }
const conversations = {};
let currentPeer = null;

function setStatus(text, ok) {
  sideStatus.textContent = text || '';
  sideStatus.className = '';
  if (!text) return;
  sideStatus.classList.add(ok ? 'ok' : 'error');
}

async function apiLogin(username, password) {
  const resp = await fetch('/login', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ username, password })
  });
  const text = await resp.text();
  let data;
  try { data = JSON.parse(text); } catch (_) {}
  if (!resp.ok) throw new Error(text || resp.status);
  return data;
}

async function apiGetPublicKey(username) {
  const resp = await fetch('/public_key?username=' + encodeURIComponent(username));
  const text = await resp.text();
  let data;
  try { data = JSON.parse(text); } catch (_) {}
  if (!resp.ok) throw new Error(text || resp.status);
  return data;
}

async function apiSendChat(fromID, toID, text) {
  const resp = await fetch('/chat/send', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ from_user_id: fromID, to_user_id: toID, text })
  });
  const bodyText = await resp.text();
  if (!resp.ok) throw new Error(bodyText || resp.status);
  return JSON.parse(bodyText);
}

async function apiGetChat(userA, userB) {
  const resp = await fetch('/chat/messages?user_a=' + userA + '&user_b=' + userB);
  const text = await resp.text();
  let data;
  try { data = JSON.parse(text); } catch (_) {}
  if (!resp.ok) throw new Error(text || resp.status);
  return data;
}

function renderMessagesForCurrent(msgs) {
  chatMessages.innerHTML = '';
  if (!msgs || !msgs.length) return;

  let maxID = 0;
  for (const m of msgs) {
    if (m.id > maxID) maxID = m.id;

    const wrapper = document.createElement('div');
    const meta = document.createElement('div');
    const body = document.createElement('div');

    const isMe = (m.from_user_id === selfID);
    wrapper.className = 'msg ' + (isMe ? 'me' : 'peer');
    meta.className = 'msg-meta';
    meta.textContent = (isMe ? 'Ты' : 'Собеседник') +
      (m.created_at ? ' · ' + m.created_at : '');
    body.textContent = m.text;

    wrapper.appendChild(meta);
    wrapper.appendChild(body);
    chatMessages.appendChild(wrapper);
  }
  chatMessages.scrollTop = chatMessages.scrollHeight;

  if (currentPeer && conversations[currentPeer]) {
    conversations[currentPeer].lastMsgID = maxID;
  }
}

async function startPolling() {
  if (!selfID || !currentPeer || !conversations[currentPeer]) return;

  if (pollTimer) clearInterval(pollTimer);

  const tick = async () => {
    try {
      const peerID = conversations[currentPeer].peerID;
      const msgs = await apiGetChat(selfID, peerID);
      renderMessagesForCurrent(msgs);
    } catch (err) {
      console.log('poll error', err);
    }
  };

  await tick();
  pollTimer = setInterval(tick, 2000);
}

function renderChatTabs() {
  chatListEl.innerHTML = '';
  const names = Object.keys(conversations).sort();

  for (const name of names) {
    const conv = conversations[name];
    const tab = document.createElement('div');
    tab.className = 'chat-tab' + (name === currentPeer ? ' active' : '');
    tab.dataset.peer = name;

    const label = document.createElement('div');
    label.className = 'chat-tab-name';
    label.textContent = name;

    const pill = document.createElement('div');
    pill.className = 'chat-tab-pill';
    pill.textContent = 'id ' + conv.peerID;

    tab.appendChild(label);
    tab.appendChild(pill);

    tab.addEventListener('click', () => {
      switchConversation(name);
    });

    chatListEl.appendChild(tab);
  }
}

async function switchConversation(peerName) {
  if (!conversations[peerName]) return;
  currentPeer = peerName;
  renderChatTabs();

  chatTitle.textContent = selfName + ' ⇄ ' + peerName;
  chatSubtitle.textContent = 'Браузерный чат (plain-text поверх шифрованного хранилища)';
  idsInfo.textContent = 'Ты: ' + selfID + ' · Собеседник: ' + conversations[peerName].peerID;

  msgInput.disabled = false;
  sendBtn.disabled = false;

  await startPolling();
}

async function ensureLoggedIn(auto) {
  if (selfID !== null) return;

  let username, password;

  if (auto) {
    try {
      username = sessionStorage.getItem('ss_username') ||
                 localStorage.getItem('ss_username') || '';
      password = sessionStorage.getItem('ss_password') || '';
    } catch (_) {}
  } else {
    username = document.getElementById('userName').value.trim();
    password = document.getElementById('userPass').value;
  }

  if (!username || !password) {
    throw new Error('Укажи логин и пароль');
  }

  const loginData = await apiLogin(username, password);
  selfID = loginData.id;
  selfName = loginData.username;

  chatSubtitle.textContent = 'Авторизован как ' + selfName;
  setStatus('Вход выполнен', true);

  try {
    localStorage.setItem('ss_username', username);
    sessionStorage.setItem('ss_username', username);
    sessionStorage.setItem('ss_password', password);
  } catch (_) {}
}

async function startDialogue(peerName, auto) {
  peerName = peerName.trim();
  if (!peerName) {
    if (!auto) setStatus('Укажи логин собеседника', false);
    return;
  }

  await ensureLoggedIn(auto);

  if (!conversations[peerName]) {
    const peerData = await apiGetPublicKey(peerName);
    conversations[peerName] = {
      peerID: peerData.id,
      lastMsgID: 0,
    };
  }

  try {
    localStorage.setItem('ss_peer', peerName);
  } catch (_) {}

  await switchConversation(peerName);
}

connectBtn.addEventListener('click', async () => {
  const peerName = document.getElementById('peerName').value;
  try {
    setStatus('Подключение…', true);
    await startDialogue(peerName, false);
  } catch (err) {
    setStatus(err.message || String(err), false);
  }
});

function autoConnectFromStorage() {
  let savedPeer = '';
  try {
    savedPeer = localStorage.getItem('ss_peer') || '';
  } catch (_) {}
  if (!savedPeer) return;
  startDialogue(savedPeer, true).catch(err => {
    console.log('auto connect error', err);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  try {
    const savedUser = localStorage.getItem('ss_username') ||
                      sessionStorage.getItem('ss_username');
    const savedPeer = localStorage.getItem('ss_peer') || '';
    if (savedUser) document.getElementById('userName').value = savedUser;
    if (savedPeer) document.getElementById('peerName').value = savedPeer;

    const savedPass = sessionStorage.getItem('ss_password');
    if (savedUser && savedPass && savedPeer) {
      setTimeout(() => autoConnectFromStorage(), 120);
    } else if (savedUser) {
      document.getElementById('userPass').focus();
    }
  } catch (_) {}
});

sendBtn.addEventListener('click', async () => {
  const text = msgInput.value.trim();
  if (!text) return;
  if (!selfID || !currentPeer || !conversations[currentPeer]) {
    setStatus('Нет активного диалога', false);
    return;
  }

  try {
    const toID = conversations[currentPeer].peerID;
    await apiSendChat(selfID, toID, text);
    msgInput.value = '';
    await startPolling();
  } catch (err) {
    setStatus('Ошибка отправки: ' + err.message, false);
  }
});

msgInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});
</script>
</body>
</html>
